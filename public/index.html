<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Black Horse AI Assistant</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai-sublime.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --primary-text: #e6e6e6;
            --secondary-text: #8b949e;
            --accent-color: #00ff41;
            --accent-glow: rgba(0, 255, 65, 0.4);
            --border-color: #333;
            --user-bubble-bg: #1a1a1a;
            --assistant-bubble-bg: #1f1f1f;
            --error-color: #ff4d4d;
        }
        html, body, #root { height: 100%; margin: 0; overflow: hidden; }
        body { font-family: 'Fira Code', monospace; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; background-color: var(--bg-color); color: var(--primary-text); }
        #root { display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .chat-main::-webkit-scrollbar { width: 6px; }
        .chat-main::-webkit-scrollbar-track { background: var(--border-color); }
        .chat-main::-webkit-scrollbar-thumb { background-color: var(--accent-color); border-radius: 6px; }
        .chat-main pre { background-color: #010409; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; white-space: pre-wrap; word-wrap: break-word; position: relative; }
        .chat-main code { font-family: 'Fira Code', monospace; }
        .copy-code-button { position: absolute; top: 8px; right: 8px; background-color: #333; border: 1px solid var(--border-color); color: var(--primary-text); padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 12px; opacity: 0.5; transition: opacity 0.2s; }
        .chat-main pre:hover .copy-code-button { opacity: 1; }
        .copy-code-button:active { background-color: var(--accent-color); color: var(--bg-color); }
    </style>
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Chatbot = () => {
          const [messages, setMessages] = useState(() => {
            try {
                const savedMessages = localStorage.getItem('bha-chat-history');
                return savedMessages 
                    ? JSON.parse(savedMessages) 
                    : [{ sender: 'assistant', type: 'text', content: 'Black Horse AI Assistant online. How can I help you?' }];
            } catch (error) {
                console.error("Failed to parse chat history:", error);
                return [{ sender: 'assistant', type: 'text', content: 'Black Horse AI Assistant online. How can I help you?' }];
            }
          });
          
          const [input, setInput] = useState('');
          const [file, setFile] = useState(null); 
          const [listening, setListening] = useState(false);
          const [isThinking, setIsThinking] = useState(false);
          const recognitionRef = useRef(null);
          const messagesEndRef = useRef(null);
          const fileInputRef = useRef(null);

          const handleCopyCode = (codeText) => {
            navigator.clipboard.writeText(codeText).catch(err => {
              console.error('Failed to copy text: ', err);
            });
          };

          useEffect(() => {
            document.querySelectorAll('pre code').forEach((block) => {
              if (!block.classList.contains('hljs')) {
                  hljs.highlightElement(block);
              }
            });

            document.querySelectorAll('pre').forEach((preElement) => {
              if (preElement.querySelector('.copy-code-button')) return;

              const codeText = preElement.querySelector('code')?.innerText;
              if (codeText) {
                const button = document.createElement('button');
                button.className = 'copy-code-button';
                button.innerText = 'Copy';
                button.onclick = () => {
                  handleCopyCode(codeText);
                  button.innerText = 'Copied!';
                  setTimeout(() => { button.innerText = 'Copy'; }, 2000);
                };
                preElement.appendChild(button);
              }
            });
            
            messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
          }, [messages]);

          useEffect(() => {
            try {
                localStorage.setItem('bha-chat-history', JSON.stringify(messages));
            } catch (error) {
                console.error("Failed to save chat history:", error);
            }
          }, [messages]);

          useEffect(() => {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) { return; }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'ar-EG';
            recognitionRef.current = recognition;
          }, []);

          const handleFileButtonClick = () => fileInputRef.current.click();
          const handleFileChange = (event) => setFile(event.target.files[0] || null);
          const removeFile = () => {
              setFile(null);
              if (fileInputRef.current) fileInputRef.current.value = null;
          };

          const readFileAsBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({ mimeType: file.type, data: reader.result.split(',')[1] });
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
          };

          const callGeminiText = async (chatHistory, fileData = null) => {
            const systemInstruction = `You are "Black Horse AI Assistant". Analyze files if provided and respond in Markdown.`;
            
            const latestUserMessage = chatHistory[chatHistory.length - 1];
            const previousHistory = chatHistory.slice(0, -1);

            const userParts = [{ text: latestUserMessage.content }];
            if (fileData) {
                userParts.push({ inlineData: { mimeType: fileData.mimeType, data: fileData.data } });
            }

            const contents = [
              ...previousHistory.map(msg => ({
                  role: msg.sender === 'user' ? 'user' : 'model',
                  parts: [{ text: msg.content }]
              })),
              { role: 'user', parts: userParts }
            ];
            
            const payload = { contents };
            const url = `/.netlify/functions/generate`; // Secure URL

            try {
                const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await resp.json();
                if (data?.candidates?.length) {
                    return { text: data.candidates[0].content.parts[0].text };
                } else {
                    return { text: `Error: ${data.error || 'No reply from AI.'}` };
                }
            } catch (err) {
                return { text: `Error: Could not connect to the secure backend.` };
            }
          };

          const handleSend = async () => {
            const trimmed = input.trim();
            if ((!trimmed && !file) || isThinking) return;

            setIsThinking(true);
            
            let userMessageContent = trimmed;
            if (file) {
              const fileInfo = `(Attached: ${file.name})`;
              userMessageContent = userMessageContent ? `${userMessageContent}\n${fileInfo}` : fileInfo;
            }

            const newMessages = [...messages, { sender: 'user', type: 'text', content: userMessageContent }];
            setMessages(newMessages);
            setInput('');
            
            let fileData = null;
            if (file) {
                try {
                    fileData = await readFileAsBase64(file);
                } catch (error) {
                    setMessages(prev => [...prev, { sender: 'assistant', type: 'text', content: 'Error: Could not read file.' }]);
                    setIsThinking(false);
                    removeFile();
                    return;
                }
            }
            
            const result = await callGeminiText(newMessages, fileData);
            setMessages(prev => [...prev, { sender: 'assistant', type: 'text', content: result.text }]);
            
            removeFile();
            setIsThinking(false);
          };
          
          const handleNewChat = () => {
            setMessages([{ sender: 'assistant', type: 'text', content: 'Black Horse AI Assistant online. How can I help you?' }]);
          };

          // --- The rest of the component ---
          return (
            <div style={{ width: '100%', maxWidth: '800px', height: '90vh', display: 'flex', flexDirection: 'column', borderRadius: '12px', border: '1px solid var(--border-color)', boxShadow: `0 0 20px var(--accent-glow)`, backgroundColor: 'var(--bg-color)'}}>
              <header style={{ padding: '1rem', borderBottom: '1px solid var(--border-color)', backgroundColor: 'rgba(13, 17, 23, 0.8)', backdropFilter: 'blur(10px)', color: 'var(--accent-color)', fontFamily: "'Orbitron', sans-serif", fontSize: 24, textAlign: 'center', borderTopLeftRadius: 12, borderTopRightRadius: 12, flexShrink: 0, display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                <button onClick={handleNewChat} title="New Chat" style={{ background: 'none', border: '1px solid var(--accent-color)', color: 'var(--accent-color)', borderRadius: '50%', width: 40, height: 40, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                </button>
                <span>Black Horse AI Assistant</span>
                <div style={{width: 40}}></div>
              </header>
              <main className="chat-main" style={{ flexGrow: 1, overflowY: 'auto', padding: '1.5rem'}}>
                {messages.map((msg, i) => (
                  <div key={i} style={{ display: 'flex', justifyContent: msg.sender === 'user' ? 'flex-end' : 'flex-start', marginBottom: '1rem'}}>
                    <div style={{ maxWidth: '75%', backgroundColor: msg.sender === 'user' ? 'var(--user-bubble-bg)' : 'var(--assistant-bubble-bg)', color: 'var(--primary-text)', borderRadius: 18, padding: '1px 18px', fontSize: 16, border: `1px solid ${msg.sender === 'user' ? 'var(--accent-color)' : 'var(--border-color)'}`, wordBreak: 'break-word'}}>
                      {msg.type === 'text' && msg.sender === 'assistant' ? (
                        <div dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }} />
                      ) : ( <p style={{margin: '12px 0', whiteSpace: 'pre-wrap'}}>{msg.content}</p> )}
                    </div>
                  </div>
                ))}
                {isThinking && <div style={{textAlign: 'center', color: 'var(--accent-color)'}}>Processing...</div>}
                <div ref={messagesEndRef} />
              </main>
              <footer style={{ display: 'flex', flexDirection: 'column', padding: '1rem', borderTop: '1px solid var(--border-color)', backgroundColor: 'rgba(13, 17, 23, 0.8)', flexShrink: 0}}>
                {file && (<div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', backgroundColor: 'var(--user-bubble-bg)', padding: '5px 10px', borderRadius: '10px', marginBottom: '10px', fontSize: '14px', border: '1px solid var(--accent-color)'}}><span>Attached: {file.name}</span><button onClick={removeFile} style={{ background: 'none', border: 'none', color: 'var(--error-color)', cursor: 'pointer', fontSize: '18px' }}>&times;</button></div>)}
                <div style={{ display: 'flex', alignItems: 'center', width: '100%' }}>
                  <input type="file" ref={fileInputRef} onChange={handleFileChange} style={{ display: 'none' }} />
                  <button onClick={handleFileButtonClick} title="Attach File" style={{ marginRight: '10px', backgroundColor: 'transparent', color: 'var(--accent-color)', border: `1px solid var(--accent-color)`, borderRadius: '50%', width: 44, height: 44, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M4.5 3a2.5 2.5 0 0 1 5 0v9a1.5 1.5 0 0 1-3 0V5a.5.5 0 0 1 1 0v7a.5.5 0 0 0 1 0V3a1.5 1.5 0 1 0-3 0v9a2.5 2.5 0 0 0 5 0V5a.5.5 0 0 1 1 0v7a3.5 3.5 0 1 1-7 0z"/></svg>
                  </button>
                  <textarea placeholder={"Enter command or attach file..."} rows={1} value={input} onChange={e => setInput(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }}} disabled={isThinking} style={{ flexGrow: 1, borderRadius: 20, border: '1px solid var(--border-color)', padding: '10px 15px', fontSize: 16, resize: 'none', outline: 'none', backgroundColor: '#010409', color: 'var(--primary-text)', fontFamily: "'Fira Code', monospace", cursor: 'text' }}/>
                  <button onClick={() => recognitionRef.current.start()} title="Voice Input" style={{ margin: '0 10px', backgroundColor: 'transparent', color: 'var(--accent-color)', border: `1px solid var(--accent-color)`, borderRadius: '50%', width: 44, height: 44, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/><path d="M8 8a3 3 0 0 0-3 3v.5a.5.5 0 0 0 1 0V11a2 2 0 0 1 4 0v.5a.5.5 0 0 0 1 0V11a3 3 0 0 0-3-3z"/></svg>
                  </button>
                  <button onClick={handleSend} disabled={isThinking} style={{ backgroundColor: 'var(--accent-color)', color: 'var(--bg-color)', border: 'none', borderRadius: 20, padding: '10px 20px', fontWeight: 'bold', fontSize: 16, cursor: 'pointer'}}>SEND</button>
                </div>
              </footer>
            </div>
          );
        };

        ReactDOM.render(<Chatbot />, document.getElementById('root'));
    </script>
</body>
</html>
